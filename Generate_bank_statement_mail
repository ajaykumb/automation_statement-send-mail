#!/bin/bash
###--------------------------------------
# Generate statement & send via email   
# Author: Ajay Kumar Behera
###--------------------------------------

# Script: aws_rds_student_report.sh
# Purpose: Fetch student data from AWS RDS MySQL and email report

# --- AWS RDS connection details ---------------------------
RDS_HOST="ajaydb.crugqsm2cgjp.ap-south-1.rds.amazonaws.com"
RDS_USER="ajaydb"
RDS_PASS="ajaykumb"
RDS_DB="testdb"

# --- Email details ------------------------------------------
TO_EMAIL="oracle.ajaykr@gmail.com"
SUBJECT="AWS RDS Student Report - $(date +%F)"
CSV_FILE="/home/omm/student_report_$(date +%F).csv"
TXT_FILE="/home/omm/student_report_$(date +%F).txt"

# 1) Create DB and table if not exists:::::::::::::::::::::::::::::
mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS <<EOF
CREATE DATABASE IF NOT EXISTS $RDS_DB;
USE $RDS_DB;
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
EOF

# 2) Insert sample records
mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS <<EOF
USE $RDS_DB;
INSERT INTO users (username, email) VALUES
('ajay', 'ajay@example.com'),
('rahul', 'rahul@example.com'),
('sita', 'sita@example.com'),
('ravi', 'ravi@example.com'),
('neha', 'neha@example.com')
ON DUPLICATE KEY UPDATE email=VALUES(email);
EOF

echo "Fetching student data from AWS RDS ($RDS_DB)..."

# 3) Fetch CSV format (tab → comma)
mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -D $RDS_DB -B -e "SELECT * from users;" \
    | sed 's/\t/,/g' > "$CSV_FILE"

# 4) Fetch pretty table format
mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -D $RDS_DB -e "SELECT * from users;" \
    | column -t > "$TXT_FILE"

# 5) Build email body
BODY=$(cat <<EOF
Hello Team,

Please find the student report from AWS RDS:

$(cat $TXT_FILE)

The CSV file is attached for your reference.

Regards,
Ajay Behera
EOF
)

# 6) Send email with attachment
if command -v mail >/dev/null 2>&1; then
    echo "$BODY" | mail -s "$SUBJECT" -a "$CSV_FILE" "$TO_EMAIL"
elif command -v mutt >/dev/null 2>&1; then
    echo "$BODY" | mutt -s "$SUBJECT" -a "$CSV_FILE" -- "$TO_EMAIL"
else
    echo "No mail client found. Please install mailutils or mutt."
    exit 1
fi

if [ $? -eq 0 ]; then
    echo "✅ Report sent successfully to $TO_EMAIL"
else
    echo "❌ Failed to send report. Check mail configuration."
fi

